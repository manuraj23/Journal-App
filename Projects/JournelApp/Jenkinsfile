pipeline {
    agent any

    tools {
        maven 'apache-maven-3.8.8'    // Jenkins > Tools config mein set hona chahiye
        jdk 'jdk21'                   // Jenkins > Tools config mein set hona chahiye
    }

    environment {
        MAVEN_HOME = tool 'apache-maven-3.8.8'
        JAVA_HOME = tool 'jdk21'
        PATH = "${MAVEN_HOME}/bin:${JAVA_HOME}/bin:${env.PATH}"
    }

    stages {
        stage('Clone Code') {
            steps {
                git 'https://github.com/manuraj23/Journal-App.git'
            }
        }

        stage('Build with Maven') {
            steps {
                dir('Projects/JournelApp') {
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Docker Build') {
            steps {
                dir('Projects/JournelApp') {
                    bat 'docker build -t journal-app .'
                }
            }
        }

        stage('Docker Run') {
            steps {
                dir('Projects/JournelApp') {
                    bat 'docker-compose up -d'
                }
            }
        }

        // Optional cleanup stage
        stage('Docker Cleanup') {
            when {
                beforeInput true
                expression { return false }  // change to `true` if you want it to auto-run
            }
            steps {
                dir('Projects/JournelApp') {
                    bat 'docker-compose down'
                }
            }
        }
    }

    post {
        failure {
            echo 'Build failed ðŸ˜ž'
        }
        success {
            echo 'Build and deployment successful ðŸš€'
        }
    }
}
